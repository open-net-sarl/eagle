<?xml version="1.0"?>
<!--
  File: contracts_view.xml
  Module: eagle_management

  Created by cyp@open-net.ch

  Copyright (c) 2011 Open-Net Ltd. All rights reserved.
-->
<openerp>
	<data>

        <!--
			Inherited contract form view from the Eagle Base module 
    	-->
		<record model="ir.ui.view" id="eagle_contract_crm_form">
			<field name="name">Eagle Contract CRM View</field>
			<field name="model">eagle.contract</field>
			<field name="inherit_id" ref="eagle_base.eagle_view_contract_form"/>
            <field name="priority" eval="17"/>
			<field name="arch" type="xml">
                <group name="top" position="inside">
					<field name="tab_profile_eagle_crm" invisible="1"/>
				</group>
				<notebook position="inside">
					<page string="CRM" attrs="{'invisible':[('tab_profile_eagle_crm','=',False),('eagle_parm_show_all_meta_tabs','=',False)]}">
                        <group>
                            <group>
                                <field name="crm_currency_id"/>
                                <label for="planned_revenue"/>
                                <div>
                                    <field name="planned_revenue" class="oe_inline" widget='monetary' options="{'currency_field': 'crm_currency_id'}"/>
                                    <span class="oe_grey"> at </span>
                                    <field name="probability" class="oe_inline" widget="integer"/>%%
                                </div>
                            </group>
                            <group>
                                <field name="src_crm_if_lead" attrs="{'invisible':[('src_crm_if_lead','=',False)]}" context="{'ons_lead_from_contract':True}"/>
                                <field name="src_crm_if_opport" attrs="{'invisible':[('src_crm_if_opport','=',False)]}" context="{'ons_opport_from_contract':True}"/>
                                <field name="crm_stage_id" context="{'cyp':'Got it!'}"/>
                            </group>
                        </group>
						<field name="eagle_crm_ids" context="{'form_view_ref':'eagle_crm.eagle_crm_contract_view', 'tree_view_ref':'eagle_crm.eagle_crm_contract_list', 'contract_id':active_id}"/>
					</page>
                </notebook>
                <group name="calendar" position="inside">
                    <label for="reminder_timestamp"/>
                    <div style="widh:95%%">
                        <field name="reminder_flag" nolabel="1"/>
                        <field name="reminder_timestamp" attrs="{'readonly':[('reminder_flag','=',False)]}" class="oe_inline"/>
                    </div>
                    <label for="auto_reminder_date"/>
                    <div style="widh:95%%">
                        <field name="auto_reminder_flag" nolabel="1"/>
                        <field name="auto_reminder_date" readonly="1" class="oe_inline"/>
                    </div>
                </group>
			</field>
		</record>
        
        <!--
			Kanban view for Eagle contract 
    	-->
		<record model="ir.ui.view" id="eagle_contract_kanban">
			<field name="name">Eagle Contract CRM Kanban</field>
			<field name="model">eagle.contract</field>
			<field name="arch" type="xml">
                <kanban default_group_by="crm_stage_id">
                    <field name="crm_stage_id"/>
                    <field name="state"/>
                    <field name="name"/>
                    <field name="planned_revenue" sum="Expected Revenues"/>
                    <field name="view_color"/>
                    <field name="date_start"/>
                    <field name="date_end"/>
                    <field name="eagle_crm_ids"/>
                    <field name="partners"/>
                    <field name="crm_partners"/>
                    <field name="cnt_partners"/>
                    <field name="probability"/>
                    <field name="crm_currency_id"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div t-attf-class="oe_kanban_color_#{kanban_getcolor(record.view_color.raw_value)} oe_kanban_card oe_kanban_global_click">
                                <div class="oe_dropdown_toggle oe_dropdown_kanban">
                                    <span class="oe_e">í</span>
                                    <ul class="oe_dropdown_menu">
                                        <li><ul class="oe_kanban_colorpicker" data-field="view_color"/></li>
                                    </ul>
                                </div>
                                <t t-if="record.crm_partners.raw_value">
                                    <div class="oe_dropdown_toggle oe_dropdown_kanban">
                                        <span class="oe_e" style="color:cyan;">í</span>
                                        <ul class="oe_dropdown_menu">
                                            <li>CRM:<ul><t t-raw="record.crm_partners.raw_value"/></ul></li>
                                        </ul>
                                    </div>
                                </t>
                                <div class="oe_kanban_content">
                                    <div>
                                        <b><field name="name"/></b>
                                        <t t-if="record.planned_revenue.raw_value">
                                            <br/>-&gt; <b><t t-esc="record.planned_revenue.value"/>
                                            <field name="crm_currency_id"/></b>
                                            @ <t t-esc="record.probability.value"/>%%
                                        </t>
                                    </div>
                                    <div style="padding-left: 0.5em">
                                        <field name="date_start"/>
                                        <t t-if="record.date_end.raw_value"> - </t>
                                        <t t-if="record.date_end.raw_value and record.date_end.raw_value lt (new Date())" t-set="red">oe_kanban_text_red</t>
                                        <span t-attf-class="#{red || ''}"><field name="date_end"/></span>
                                    </div>
                                    <div style="padding-left: 0.5em" name="status">
                                        Status: <field name="state" nolabel="1"/>
                                    </div>
                                    <t t-if="record.cnt_partners.raw_value">
                                        <div>
                                            Participants:<ul><t t-raw="record.cnt_partners.raw_value"/></ul>
                                        </div>
                                    </t>
                                </div>
                                <div class="oe_clear"></div>
                            </div>
                        </t>
                    </templates>
                </kanban>
			</field>
		</record>

        <record model="ir.ui.view" id="eagle_contract_crm_filter">
			<field name="name">Eagle Contract CRM Filter</field>
			<field name="model">eagle.contract</field>
			<field name="inherit_id" ref="eagle_base.eagle_view_contract_filter"/>
            <field name="priority" eval="17"/>
			<field name="arch" type="xml">
                <group  string="Group by..." position="inside">
                    <filter string="Stage" domain="[]" context="{'group_by':'crm_stage_id'}"/>
				</group>
			</field>
		</record>
                
        <record model="ir.actions.act_window" id="eagle_base.eagle_action_contract_filter_all_tree">
            <field name="name">All Contracts</field>
            <field name="res_model">eagle.contract</field>
            <field name="view_type">form</field>
            <field name="view_mode">kanban,tree,form</field>
            <field name="view_id" ref="eagle_base.eagle_view_contract_tree"/>
            <field name="search_view_id" ref="eagle_base.eagle_view_contract_filter"/>
        </record>

        <!--
			Calendar view for Eagle contract 
    	-->
		<record model="ir.ui.view" id="eagle_contract_calendar">
			<field name="name">Eagle Contract CRM Calendar</field>
			<field name="model">eagle.contract</field>
			<field name="arch" type="xml">
                <calendar string="TODO" color="user_id" date_start="current_reminder">
                    <field name="notes"/>
                </calendar>
			</field>
		</record>
                
        <record model="ir.actions.act_window" id="eagle_action_contract_calendar">
            <field name="name">TODO's</field>
            <field name="res_model">eagle.contract</field>
            <field name="view_type">form</field>
            <field name="view_mode">calendar</field>
            <field name="view_id" ref="eagle_contract_calendar"/>
            <field name="search_view_id" ref="eagle_base.eagle_view_contract_filter"/>
        </record>

        <menuitem
			name="TODO's" 
			action="eagle_action_contract_calendar"
			id="eagle_menu_contract_calendar"
			parent="eagle_base.eagle_menu_contracts_root"
			icon="STOCK_APPLY" 
			sequence="22" 
			groups="eagle_base.group_contracts_viewers,eagle_base.group_contracts_editors,eagle_base.group_contracts_managers"/>

	</data>
</openerp>
